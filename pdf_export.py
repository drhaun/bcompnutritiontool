"""
PDF Export functionality for meal plans with Fitomics branding
"""
from fpdf import FPDF
import os
from datetime import datetime
import json
import traceback

class FitomicsPDF(FPDF):
    def __init__(self):
        super().__init__()
        self.set_auto_page_break(auto=True, margin=15)
        
    def header(self):
        """Add Fitomics branded header"""
        # Try multiple logo paths
        logo_paths = [
            "attached_assets/fitomicshorizontalgold.png",
            "attached_assets/Fitomics Logomark – Dark Blue.png",
            "attached_assets/Fitomics Logomark – Dark Gold.png"
        ]
        
        logo_added = False
        for logo_path in logo_paths:
            if os.path.exists(logo_path):
                try:
                    self.image(logo_path, 10, 8, 40)
                    logo_added = True
                    break
                except:
                    continue
        
        # Fitomics branding text
        if not logo_added:
            self.set_font('Arial', 'B', 24)
            self.set_text_color(193, 153, 98)  # Fitomics gold
            self.cell(0, 15, 'FITOMICS', 0, 1, 'C')
        else:
            self.ln(20)
        
        self.set_font('Arial', '', 12)
        self.set_text_color(100, 100, 100)
        self.cell(0, 5, 'Personalized Nutrition & Body Composition Planning', 0, 1, 'C')
        self.ln(10)
        
    def footer(self):
        """Add footer with page number and branding"""
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.set_text_color(128, 128, 128)
        self.cell(0, 10, f'Generated by Fitomics AI - Page {self.page_no()}', 0, 0, 'C')
        
    def add_title_page(self, user_info, plan_info):
        """Add a branded title page"""
        self.add_page()
        
        # Main title
        self.ln(20)
        self.set_font('Arial', 'B', 28)
        self.set_text_color(41, 84, 144)
        self.cell(0, 15, 'AI MEAL PLAN', 0, 1, 'C')
        
        self.set_font('Arial', '', 16)
        self.set_text_color(100, 100, 100)
        self.cell(0, 8, 'Personalized Nutrition Strategy', 0, 1, 'C')
        
        # User info section
        self.ln(20)
        self.set_font('Arial', 'B', 14)
        self.set_text_color(0, 0, 0)
        self.cell(0, 8, 'PLAN DETAILS', 0, 1, 'L')
        
        self.set_font('Arial', '', 12)
        self.cell(0, 6, f"Generated: {datetime.now().strftime('%B %d, %Y')}", 0, 1, 'L')
        
        # Add profile summary if available
        if user_info and 'profile' in user_info:
            profile = user_info['profile']
            goals = user_info.get('goals', {})
            
            if profile:
                self.ln(5)
                self.set_font('Arial', 'B', 14)
                self.cell(0, 8, 'PROFILE SUMMARY', 0, 1, 'L')
                
                self.set_font('Arial', '', 12)
                if profile.get('name'):
                    self.cell(0, 6, f"Name: {profile['name']}", 0, 1, 'L')
                if profile.get('age'):
                    self.cell(0, 6, f"Age: {profile['age']} years", 0, 1, 'L')
                if profile.get('gender'):
                    self.cell(0, 6, f"Gender: {profile['gender']}", 0, 1, 'L')
                if profile.get('weight_lbs'):
                    self.cell(0, 6, f"Weight: {profile['weight_lbs']} lbs", 0, 1, 'L')
                if profile.get('height_ft') and profile.get('height_in'):
                    self.cell(0, 6, f"Height: {profile['height_ft']}'{profile['height_in']}\"", 0, 1, 'L')
                if profile.get('activity_level'):
                    self.cell(0, 6, f"Activity Level: {profile['activity_level']}", 0, 1, 'L')
                
                # Add goals if available
                if goals:
                    self.ln(3)
                    self.set_font('Arial', 'B', 12)
                    self.cell(0, 6, 'Goals:', 0, 1, 'L')
                    self.set_font('Arial', '', 12)
                    if goals.get('goal_type'):
                        self.cell(0, 6, f"Primary Goal: {goals['goal_type']}", 0, 1, 'L')
                    if goals.get('target_weight_lbs'):
                        self.cell(0, 6, f"Target Weight: {goals['target_weight_lbs']} lbs", 0, 1, 'L')
                    if goals.get('target_bf'):
                        self.cell(0, 6, f"Target Body Fat: {goals['target_bf']}%", 0, 1, 'L')
        self.cell(0, 6, f"Daily Calories: {plan_info.get('total_calories', 'N/A')}", 0, 1, 'L')
        self.cell(0, 6, f"Protein: {plan_info.get('total_protein', 'N/A')}g", 0, 1, 'L')
        self.cell(0, 6, f"Carbohydrates: {plan_info.get('total_carbs', 'N/A')}g", 0, 1, 'L')
        self.cell(0, 6, f"Fat: {plan_info.get('total_fat', 'N/A')}g", 0, 1, 'L')
        
        # Diet preferences
        diet_prefs = plan_info.get('diet_preferences', {})
        if any(diet_prefs.values()):
            self.ln(10)
            self.set_font('Arial', 'B', 14)
            self.cell(0, 8, 'DIETARY PREFERENCES', 0, 1, 'L')
            
            self.set_font('Arial', '', 12)
            prefs = []
            if diet_prefs.get('vegetarian'): prefs.append('Vegetarian')
            if diet_prefs.get('vegan'): prefs.append('Vegan')
            if diet_prefs.get('gluten_free'): prefs.append('Gluten-Free')
            if diet_prefs.get('dairy_free'): prefs.append('Dairy-Free')
            
            for pref in prefs:
                self.cell(0, 6, f"- {pref}", 0, 1, 'L')
                
    def add_meal_section(self, meal_type, recipe, macros, ingredients, meal_context=None, meal_time=None):
        """Add a meal section with recipe and ingredients"""
        # Meal title
        self.set_font('Arial', 'B', 16)
        self.set_text_color(41, 84, 144)
        self.cell(0, 10, meal_type.upper(), 0, 1, 'L')
        
        # Recipe name
        self.set_font('Arial', 'B', 14)
        self.set_text_color(0, 0, 0)
        recipe_name = recipe.get('name', recipe.get('title', 'Custom Meal'))
        self.cell(0, 8, recipe_name, 0, 1, 'L')
        
        # Add meal context and time if available
        if meal_context or meal_time:
            self.set_font('Arial', '', 10)
            self.set_text_color(100, 100, 100)
            context_parts = []
            if meal_time:
                context_parts.append(f"Time: {meal_time}")
            if meal_context:
                context_parts.append(f"Context: {meal_context}")
            self.cell(0, 5, " | ".join(context_parts), 0, 1, 'L')
            self.set_text_color(0, 0, 0)
        
        # Macros box
        self.ln(2)
        self.set_fill_color(245, 245, 245)
        self.rect(10, self.get_y(), 190, 20, 'F')
        
        # Macros in columns
        y_pos = self.get_y() + 5
        self.set_xy(15, y_pos)
        self.set_font('Arial', 'B', 10)
        
        # Format macro values properly
        calories = int(macros.get('calories', 0)) if macros.get('calories') else 0
        protein = round(float(macros.get('protein', 0)), 1) if macros.get('protein') else 0
        carbs = round(float(macros.get('carbs', 0)), 1) if macros.get('carbs') else 0
        fat = round(float(macros.get('fat', 0)), 1) if macros.get('fat') else 0
        
        self.cell(45, 5, f"Calories: {calories}", 0, 0, 'L')
        self.set_x(60)
        self.cell(45, 5, f"Protein: {protein}g", 0, 0, 'L')
        self.set_x(105)
        self.cell(45, 5, f"Carbs: {carbs}g", 0, 0, 'L')
        self.set_x(150)
        self.cell(45, 5, f"Fat: {fat}g", 0, 1, 'L')
        
        self.ln(15)
        
        # Ingredients
        self.set_font('Arial', 'B', 12)
        self.cell(0, 6, 'INGREDIENTS:', 0, 1, 'L')
        
        self.set_font('Arial', '', 10)
        for ingredient in ingredients:
            if isinstance(ingredient, dict):
                # Try different keys for ingredient name
                name = ingredient.get('item', ingredient.get('name', 'Unknown'))
                amount = ingredient.get('amount', 0)
                # Clean up amount formatting - preserve units
                if isinstance(amount, str):
                    self.cell(0, 5, f"- {amount} {name}", 0, 1, 'L')
                else:
                    self.cell(0, 5, f"- {amount}g {name}", 0, 1, 'L')
            else:
                self.cell(0, 5, f"- {ingredient}", 0, 1, 'L')
        
        # Instructions/Directions
        instructions = recipe.get('instructions', recipe.get('directions', []))
        if instructions:
            self.ln(3)
            self.set_font('Arial', 'B', 12)
            self.cell(0, 6, 'INSTRUCTIONS:', 0, 1, 'L')
            
            self.set_font('Arial', '', 10)
            if isinstance(instructions, list):
                for i, instruction in enumerate(instructions, 1):
                    self.cell(0, 5, f"{i}. {instruction}", 0, 1, 'L')
            else:
                # Split text instructions into lines
                lines = str(instructions).split('. ')
                for i, line in enumerate(lines, 1):
                    if line.strip():
                        self.cell(0, 5, f"{i}. {line.strip()}", 0, 1, 'L')
        
        self.ln(8)
        
    def add_grocery_list(self, all_ingredients):
        """Add consolidated grocery list"""
        self.add_page()
        
        self.set_font('Arial', 'B', 18)
        self.set_text_color(41, 84, 144)
        self.cell(0, 12, 'GROCERY LIST', 0, 1, 'L')
        
        # Consolidate ingredients by name
        consolidated = {}
        for ingredient in all_ingredients:
            if isinstance(ingredient, dict):
                name = ingredient.get('name', ingredient.get('item', ''))
                amount_str = str(ingredient.get('amount', ''))
                
                # Skip empty names or amounts
                if not name or not amount_str:
                    continue
                
                # Store amounts as strings to preserve units (like "200g", "1 cup")
                if name in consolidated:
                    if isinstance(consolidated[name], list):
                        consolidated[name].append(amount_str)
                    else:
                        consolidated[name] = [consolidated[name], amount_str]
                else:
                    consolidated[name] = amount_str
        
        # Sort and display
        self.set_font('Arial', '', 11)
        self.set_text_color(0, 0, 0)
        
        for name, amounts in sorted(consolidated.items()):
            if name:
                if isinstance(amounts, list):
                    # Multiple amounts for same ingredient
                    combined_amounts = ", ".join(amounts)
                    self.cell(0, 6, f"- {name}: {combined_amounts}", 0, 1, 'L')
                else:
                    # Single amount
                    self.cell(0, 6, f"- {name}: {amounts}", 0, 1, 'L')

def export_meal_plan_pdf(meal_data, user_preferences=None):
    """Export complete meal plan with grocery list to branded PDF"""
    try:
        print("Starting PDF creation...")
        print(f"Meal data type: {type(meal_data)}")
        print(f"Meal data length: {len(meal_data) if meal_data else 'None'}")
        
        # Debug: Print first few items to understand structure
        if meal_data:
            print("First meal data sample:")
            if isinstance(meal_data, list) and len(meal_data) > 0:
                print(json.dumps(meal_data[0], indent=2, default=str))
            elif isinstance(meal_data, dict):
                first_key = list(meal_data.keys())[0] if meal_data else None
                if first_key:
                    print(f"First key: {first_key}")
                    print(json.dumps(meal_data[first_key], indent=2, default=str))
        
        pdf = FitomicsPDF()
        
        # Safely extract plan info with error handling
        total_calories = 0
        total_protein = 0
        total_carbs = 0
        total_fat = 0
        
        print(f"Processing {len(meal_data)} meals...")
        
        # Handle both dictionary and list formats
        if isinstance(meal_data, dict):
            meals_to_process = meal_data.values()
        else:
            meals_to_process = meal_data
            
        for meal in meals_to_process:
            # Handle different meal data structures
            if isinstance(meal, dict):
                # Check for recipe structure first
                if 'recipe' in meal and isinstance(meal['recipe'], dict):
                    recipe_macros = meal['recipe'].get('macros', {})
                    total_calories += float(recipe_macros.get('calories', 0) or 0)
                    total_protein += float(recipe_macros.get('protein', 0) or 0)
                    total_carbs += float(recipe_macros.get('carbs', 0) or 0)
                    total_fat += float(recipe_macros.get('fat', 0) or 0)
                    continue
                
                # Try different possible macro locations
                macros = meal.get('macros', meal.get('total_macros', {}))
                if not macros and 'calories' in meal:
                    macros = meal  # The meal itself contains the macros
                    
                # Handle meals array from AI response
                if 'meals' in meal:
                    for submeal in meal['meals']:
                        submacros = submeal.get('total_macros', {})
                        total_calories += float(submacros.get('calories', 0) or 0)
                        total_protein += float(submacros.get('protein', 0) or 0)
                        total_carbs += float(submacros.get('carbs', 0) or 0)
                        total_fat += float(submacros.get('fat', 0) or 0)
                else:
                    total_calories += float(macros.get('calories', 0) or 0)
                    total_protein += float(macros.get('protein', 0) or 0)
                    total_carbs += float(macros.get('carbs', 0) or 0)
                    total_fat += float(macros.get('fat', 0) or 0)
        
        plan_info = {
            'total_calories': int(total_calories),
            'total_protein': round(total_protein, 1),
            'total_carbs': round(total_carbs, 1),
            'total_fat': round(total_fat, 1),
            'diet_preferences': user_preferences or {}
        }
        
        print("Adding title page...")
        # Add title page
        pdf.add_title_page({}, plan_info)
        
        print("Adding meals page...")
        # Add meals page
        pdf.add_page()
        pdf.set_font('Arial', 'B', 20)
        pdf.set_text_color(193, 153, 98)  # Fitomics gold
        pdf.cell(0, 12, 'DAILY MEAL PLAN', 0, 1, 'L')
        pdf.ln(5)
        
        all_ingredients = []
        
        # Handle both dictionary and list formats
        if isinstance(meal_data, dict):
            items_to_process = meal_data.items()
        else:
            items_to_process = enumerate(meal_data)
            
        for meal_identifier, meal_info in items_to_process:
            if isinstance(meal_identifier, int):
                meal_type = meal_info.get('meal_type', meal_info.get('name', f'Meal {meal_identifier + 1}'))
            else:
                meal_type = meal_identifier
                
            print(f"Processing meal: {meal_type}")
            
            # Handle different meal data structures from AI response
            if 'meals' in meal_info:
                # This is a daily meal plan with multiple meals
                for submeal in meal_info['meals']:
                    submeal_name = submeal.get('name', 'Meal')
                    submeal_macros = submeal.get('total_macros', {})
                    submeal_ingredients = submeal.get('ingredients', [])
                    
                    # Add meal section to PDF with context
                    pdf.add_meal_section(
                        meal_type=submeal_name,
                        recipe=submeal,
                        macros=submeal_macros,
                        ingredients=submeal_ingredients,
                        meal_context=submeal.get('context'),
                        meal_time=submeal.get('time')
                    )
                    
                    # Collect ingredients for grocery list
                    for ingredient in submeal_ingredients:
                        if isinstance(ingredient, dict):
                            all_ingredients.append({
                                'name': ingredient.get('item', ''),
                                'amount': ingredient.get('amount', ''),
                                'unit': 'serving'
                            })
                continue
            else:
                # Handle recipe structure from AI meal planning
                if 'recipe' in meal_info:
                    recipe = meal_info['recipe']
                    meal_name = recipe.get('name', meal_type)
                    macros = recipe.get('macros', {})
                    ingredients = recipe.get('ingredients', [])
                    
                    # Add to PDF with context
                    pdf.add_meal_section(
                        meal_type=meal_name,
                        recipe=recipe,
                        macros=macros,
                        ingredients=ingredients,
                        meal_context=meal_info.get('context'),
                        meal_time=meal_info.get('time')
                    )
                    
                    # Collect ingredients for grocery list
                    for ingredient in ingredients:
                        if isinstance(ingredient, dict):
                            all_ingredients.append({
                                'name': ingredient.get('item', ingredient.get('name', '')),
                                'amount': ingredient.get('amount', ''),
                                'unit': 'serving'
                            })
                    continue
                
                # Single meal structure (fallback)
                recipe = meal_info.get('recipe', meal_info)
                macros = meal_info.get('macros', meal_info.get('total_macros', {}))
                ingredients = meal_info.get('ingredient_details', meal_info.get('ingredients', []))
            
            if ingredients:
                all_ingredients.extend(ingredients)
            
            pdf.add_meal_section(
                meal_type=meal_type,
                recipe=recipe,
                macros=macros,
                ingredients=ingredients,
                meal_context=meal_info.get('context'),
                meal_time=meal_info.get('time')
            )
        
        print(f"Adding grocery list with {len(all_ingredients)} ingredients...")
        # Add grocery list on new page
        if all_ingredients:
            pdf.add_grocery_list(all_ingredients)
        
        # Save PDF with error handling
        filename = f"fitomics_meal_plan_{datetime.now().strftime('%Y%m%d_%H%M')}.pdf"
        
        print(f"Saving PDF as {filename}...")
        pdf.output(filename)
        print("PDF created successfully!")
        return filename
        
    except Exception as e:
        print(f"Error creating PDF: {e}")
        print(f"Full traceback: {traceback.format_exc()}")
        return None